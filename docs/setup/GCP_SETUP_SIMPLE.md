# Cloud RunのForbiddenエラーを解決する方法（わかりやすく）

## 問題

URLにアクセスすると「Error: Forbidden」エラーが表示される

## 解決方法（3ステップ）

### ステップ1: GCPコンソールにアクセス

1. ブラウザで以下のURLを開く:
   ```
   https://console.cloud.google.com/
   ```

2. 左上の「プロジェクトを選択」をクリック
3. 「gym-reserve-app」を選択（選択済みならそのまま）

---

### ステップ2: Cloud Runのページを開く

1. 左側のメニューを探す（もしメニューが表示されていない場合）
   - 左上の「☰」（ハンバーガーメニュー）をクリック

2. メニューの中から「Cloud Run」を探してクリック
   - 「コンピューティング」というグループの中にある場合があります
   - または、検索ボックス（メニュー上部の虫眼鏡アイコン）で「Cloud Run」と入力して検索

3. Cloud Runのページが表示されます
   - サービス一覧が表示されているはずです

---

### ステップ3: サービスに未認証アクセスを許可する

#### 方法A: サービス詳細ページから設定（推奨）

1. サービス一覧から「**gym-reserve-app**」をクリック
   - サービス名のリンクをクリックしてください

2. サービス詳細ページが開きます

3. ページ上部にタブが表示されています：
   ```
   [リビジョン] [ログ] [メトリック] [YAML] [権限] [その他]
   ```
   「**権限**」タブをクリック

   ※「権限」タブが見つからない場合：
   - ページを少しスクロールしてみてください
   - または、方法Bを試してください

4. 「**プリンシパルを追加**」というボタンをクリック
   - オレンジ色または青色のボタンです

5. 以下のように設定します：
   - **新しいプリンシパル**: テキストボックスに「**allUsers**」と入力
   - **ロールを選択**: ドロップダウンメニューから「**Cloud Run 起動元**」を選択
     - 検索ボックスに「run.invoker」と入力すると見つけやすいです

6. 「**保存**」ボタンをクリック

7. 確認ダイアログが表示されたら「**確認**」をクリック
   - 「誰でもアクセスできるようになります」という警告が出ますが、問題ありません

---

#### 方法B: IAMと管理から設定（方法Aでタブが見つからない場合）

1. 左側のメニュー（☰）をクリック

2. 「**IAMと管理**」→「**IAM**」をクリック

3. ページ上部の「**+ プリンシパルを追加**」ボタンをクリック

4. 以下のように設定：
   - **新しいプリンシパル**: 「**allUsers**」と入力
   - **ロールを選択**: 「**Cloud Run 起動元**」を選択

5. 「**保存**」をクリック

---

### ステップ4: 動作確認

1. 設定後、数秒から1分ほど待ちます（設定の反映に時間がかかることがあります）

2. 以下のURLにアクセス:
   ```
   https://gym-reserve-app-1094873497912.asia-northeast1.run.app/
   ```

3. 正常にページが表示されれば成功です！

---

## よくある質問

### Q1: 「権限」タブが見つからない

**A:** 方法Bを試してください。または、ページをリロードしてみてください。

### Q2: 「allUsers」を入力するとエラーになる

**A:** 組織ポリシーで制限されている可能性があります。その場合は、プロジェクトの管理者に相談してください。

### Q3: 設定したのにまだForbiddenエラーが出る

**A:** 以下のことを確認してください：
- 設定を保存したか（「保存」ボタンをクリックしたか）
- 数秒から1分ほど待ってから再度アクセスしてみる
- ブラウザのキャッシュをクリアして再度アクセス

### Q4: 「Cloud Run 起動元」というロールが見つからない

**A:** 検索ボックスに「invoker」や「run.invoker」と入力してみてください。
「roles/run.invoker」と表示される場合もあります。

---

## まとめ

1. GCPコンソールを開く
2. Cloud Run → gym-reserve-app を選択
3. 「権限」タブ → 「プリンシパルを追加」
4. 「allUsers」と「Cloud Run 起動元」を設定
5. 保存して確認

これで完了です！


