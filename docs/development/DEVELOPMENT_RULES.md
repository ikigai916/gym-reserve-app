# 開発ルール

このドキュメントでは、開発時に必ず遵守すべき明確なルールを定義します。

## ルール1: ドキュメントとコードの整合性（必須）

### ルール

**コードを変更した場合、必ず関連ドキュメントも更新すること**

### 対象ドキュメント

1. **仕様書（`specification.md`）**
   - 機能追加・変更時
   - データモデル変更時
   - API仕様変更時

2. **その他のドキュメント**
   - `FEATURE_LIST.md`: 機能一覧の更新
   - `SCREEN_LIST.md`: 画面一覧の更新
   - `README.md`: セットアップ手順の変更時

### チェックリスト

コミット前に以下を確認：

- [ ] 追加・変更した機能が `specification.md` に記載されているか
- [ ] データモデルの変更が `specification.md` の「3. データモデル」セクションに反映されているか
- [ ] APIエンドポイントの追加・変更がドキュメントに記載されているか
- [ ] `FEATURE_LIST.md` の「実装済み機能」に新機能が追加されているか

### PRレビュー時の確認

PRレビュー時に以下を確認（`/github:pull-request-review` で自動確認）：

- [ ] 変更したコードに対応するドキュメントの差分があるか
- [ ] ドキュメントがコードと一致しているか

---

## ルール2: 動作確認（必須）

### ルール

**実装完了後、必ず動作確認を実施すること。動作確認なしでコミット・PR作成は禁止**

### 必須確認項目

#### 実装完了時（コミット前）

- [ ] **ローカル環境で動作確認**
  - バックエンドサーバーを起動（`uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`）
  - ブラウザで該当機能をテスト
  - エラーが発生しないことを確認

- [ ] **正常系のテスト**
  - 想定どおりの動作をするか確認
  - UIが正しく表示されるか確認

- [ ] **異常系のテスト（該当する場合）**
  - エラーケースの動作確認
  - バリデーションエラーの表示確認
  - エラーメッセージが適切か確認

- [ ] **既存機能への影響確認**
  - 既存の機能が壊れていないか確認（回帰テスト）
  - 特にAPIの変更時は、フロントエンド側の動作確認

#### PR作成前

- [ ] 上記すべての確認が完了していること

#### マージ後（本番デプロイ後）

- [ ] **本番環境での動作確認**
  - Cloud Runにデプロイ後、本番URLで動作確認
  - セキュリティ設定が適切か確認

### 動作確認記録

重要な機能追加時は、動作確認の結果をPRのコメントに記載すること。

---

## ルール3: Issueと実装の整合性（必須）

### ルール

**PR作成時、Issueで要求された内容と実装内容が一致していることを確認すること**

### チェックフロー

#### PR作成時（`/github:pull-request-create` 実行時）

1. **Issue内容の確認**
   - 対応するIssueを確認
   - Issueで要求されている項目をリストアップ

2. **実装内容の確認**
   - 実装した機能をリストアップ
   - Issueの要求項目と実装内容を比較

3. **差分チェック**
   - **Issueの要求項目が実装されていない場合**
     - 実装できない理由がある場合: Issueにコメントを追加して理由を記載
     - 実装可能な場合: 実装を完了してからPRを作成
   - **実装した項目がIssueに記載されていない場合**
     - Issueが正しい場合: Issueを更新して追加項目を記載
     - 実装が正しい場合: 実装を削除するか、Issueに追加項目として記載

### PR本文の記載

PR本文に以下を記載：

- Issue #XX の対応内容
- 実装した機能の一覧
- 実装しなかった項目（ある場合）とその理由

### 例

```markdown
## Issue対応内容

- Issue #3: 予約データモデルの拡張
  - ✅ userIdフィールドの追加
  - ✅ timeSlotフィールドの追加
  - ✅ statusフィールドの追加
  - ⚠️ trainerIdフィールドはOptionalとして追加（将来必須化予定）

## 実装内容

- `ReservationCreate`/`ReservationResponse`スキーマを追加
- `POST /api/reservations`（新形式）を追加
- `GET /api/reservations`（新形式）を追加
```

---

## ルール4: コミットメッセージ（必須）

### ルール

**コミットメッセージは必ずConventional Commit形式に従うこと。カスタムコマンド `/github:commit-single` を使用すること**

### 必須フォーマット

```
{type}: {subject}

{body（任意）}

{footer（任意）}
```

### Type（必須）

以下のいずれかを使用：

- `feat`: 新機能の追加
- `fix`: バグ修正
- `refactor`: リファクタリング（機能追加・修正以外のコード変更）
- `docs`: ドキュメントの変更のみ
- `style`: コードスタイルの変更（フォーマット、セミコロンなど）
- `test`: テストの追加・変更
- `chore`: ビルドやツールの変更

### Subject（必須）

- 日本語で記述
- 50文字以内を推奨
- 動詞で始める（例: 「追加する」ではなく「追加」）
- 末尾にピリオドを付けない

### Body（任意）

- 変更の理由や詳細を記載
- 日本語で記述

### Footer（任意）

- `Resolves #XX` や `Closes #XX` でIssue番号を記載

### 良い例

```
feat: ロール管理機能の実装（Issue #15）

- UserCreate, UserResponseにroleフィールドを追加
- ログイン画面にロール選択UIを追加
- 既存データとの互換性を考慮

Resolves #15
```

### 悪い例

```
❌ 機能追加
❌ ロール管理
❌ feat: ロール管理機能の実装（Issue #15）.
❌ feat: ロール管理機能を実装しました（Issue #15）
```

### 禁止事項

- カスタムコマンド `/github:commit-single` を使用せずに手動でコミットすること（緊急時を除く）
- Conventional Commit形式に従わないコミットメッセージ

---

## ルール5: 実装順序（必須）

### ルール

**`ISSUE_PRIORITY.md` に記載された優先度に従って実装すること**

### 優先度の順序

1. **Phase 1（MVP）- priority: high**
   - 最優先で実装
   - 依存関係を考慮して順番に実装

2. **Phase 2 - priority: medium**
   - Phase 1完了後に実装

3. **Phase 3 - priority: low**
   - Phase 1, 2完了後に実装

### 依存関係の考慮

実装前に以下を確認：

- [ ] 依存するIssueが完了しているか
- [ ] 依存するデータモデルが実装されているか
- [ ] 依存するAPIが実装されているか

### 例外

以下の場合は優先度を変更可能：

- セキュリティ関連のバグ修正
- クリティカルなバグ修正
- ビジネス要件の変更

**変更時は `ISSUE_PRIORITY.md` を更新し、変更理由をIssueにコメントとして記載すること**

---

## ルール6: テストコード（推奨→必須化予定）

### ルール

**重要なビジネスロジックにはテストコードを追加すること**

### 必須テスト（Phase 1完了後、Phase 2以降で必須化）

以下の機能にはテストコードを追加：

- [ ] APIエンドポイントのテスト
- [ ] データバリデーションのテスト
- [ ] ビジネスロジック（予約作成、キャンセルなど）のテスト

### テストフレームワーク

- バックエンド: `pytest`（今後導入予定）
- フロントエンド: （今後検討）

### 現時点での推奨

Phase 1（MVP）では、手動テストを徹底する。
Phase 2以降でテストコードを必須化する予定。

---

## ルール7: エラーハンドリングとログ（必須）

### ルール

**適切なエラーハンドリングとログ出力を実装すること**

### エラーハンドリング

#### APIエンドポイント

- [ ] **適切なHTTPステータスコードを返す**
  - 400: バリデーションエラー
  - 404: リソースが見つからない
  - 500: サーバーエラー

- [ ] **エラーメッセージを返す**
  - ユーザー向け: 分かりやすい日本語のメッセージ
  - 開発者向け: デバッグに役立つ詳細情報（ログに出力）

#### 例

```python
try:
    # 処理
    pass
except ValueError as e:
    raise HTTPException(status_code=400, detail="バリデーションエラー: 入力値が不正です")
except Exception as e:
    print(f"Error: {type(e).__name__}: {str(e)}")  # ログ出力
    raise HTTPException(status_code=500, detail="サーバーエラーが発生しました")
```

### ログ出力

- [ ] **重要な処理にログを出力**
  - ユーザー作成、予約作成などの重要な操作
  - エラー発生時

- [ ] **機密情報をログに出力しない**
  - パスワード、トークン、個人情報などはログに出力しない

#### 例

```python
# ✅ 良い例
print(f"User created: user_id={user_id}, name={user_name}")

# ❌ 悪い例
print(f"User created: {user_data}")  # 機密情報が含まれる可能性
```

### チェックリスト

実装時に以下を確認：

- [ ] すべてのAPIエンドポイントで適切なエラーハンドリングが実装されているか
- [ ] エラーメッセージがユーザーにとって分かりやすいか
- [ ] ログに機密情報が出力されていないか
- [ ] エラー発生時に適切なログが出力されるか

---

## ルール違反時の対応

### 軽微な違反

- ドキュメント未更新
- コミットメッセージが不適切

**対応:** PRレビュー時に指摘し、修正を依頼

### 重大な違反

- 動作確認なしでPR作成
- セキュリティ設定の見落とし
- テスト未実施で本番デプロイ

**対応:** PRをクローズし、修正後に再作成

---

## 関連ドキュメント

- `DEVELOPMENT_WORKFLOW.md`: 開発フローの詳細
- `SECURITY_CHECKLIST.md`: セキュリティチェックリスト
- `ISSUE_PRIORITY.md`: Issue優先度一覧
- `CUSTOM_COMMANDS_SETUP.md`: カスタムコマンドの使い方

