<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¸ãƒ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div x-data="app()" class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
        
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">ğŸ‹ï¸ ã‚¸ãƒ äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
            <div class="flex items-center gap-2">
                <span x-show="userName" class="text-sm text-gray-600" x-text="'ã‚ˆã†ã“ãã€' + userName + 'ã•ã‚“'"></span>
                <button @click="handleLogout" class="text-sm text-blue-600 hover:text-blue-800">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        
        <div x-show="!userId" class="mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg">
            <p class="text-sm text-yellow-800">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚</p>
            <a href="/login.html" class="text-blue-600 hover:text-blue-800 text-sm underline">ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸</a>
        </div>

        <!-- æœˆã®åˆ‡ã‚Šæ›¿ãˆ -->
        <div x-show="userId" class="flex justify-between items-center mb-4">
            <button @click="previousMonth" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                â† å‰æœˆ
            </button>
            <h2 class="text-xl font-bold text-gray-800" x-text="getMonthYearLabel()"></h2>
            <button @click="nextMonth" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition">
                æ¬¡æœˆ â†’
            </button>
        </div>

        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div x-show="userId" class="mb-6">
            <div class="grid grid-cols-7 gap-2 mb-4 text-center text-xs font-bold text-gray-500">
                <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>

            <div class="grid grid-cols-7 gap-2">
                <template x-for="day in getCalendarDays()">
                    <button 
                        @click="handleDateClick(day)"
                        :disabled="day.isPast"
                        :class="getDateButtonClass(day)"
                        class="h-12 border rounded-lg flex flex-col items-center justify-center transition text-xs"
                        :title="getDateTooltip(day)">
                        <span x-text="day.date"></span>
                        <span x-show="day.reservationCount > 0" 
                              class="text-xs mt-0.5"
                              :class="day.isMyReservation ? 'text-blue-700' : 'text-gray-600'"
                              x-text="day.reservationCount > 1 ? day.reservationCount : ''"></span>
                    </button>
                </template>
            </div>
        </div>

        <!-- äºˆç´„ä¸€è¦§ -->
        <div x-show="userId && currentMonthReservations.length > 0" class="mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-3">äºˆç´„ä¸€è¦§</h3>
            <div class="space-y-2">
                <template x-for="reservation in currentMonthReservations">
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border"
                         :class="reservation.isMyReservation ? 'bg-blue-50 border-blue-200' : 'border-gray-200'">
                        <div>
                            <div class="font-semibold text-gray-800" x-text="reservation.date"></div>
                            <div class="text-sm text-gray-600" x-text="reservation.user_name"></div>
                        </div>
                        <div x-show="reservation.isMyReservation" class="text-xs text-blue-600 font-semibold">
                            ã‚ãªãŸã®äºˆç´„
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«: äºˆç´„å…¥åŠ› -->
        <div x-show="showReservationModal" 
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
             @click.self="showReservationModal = false">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">äºˆç´„ã‚’ç™»éŒ²</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">äºˆç´„æ—¥</label>
                    <div class="px-4 py-2 bg-gray-100 rounded-lg" x-text="selectedDateLabel"></div>
                </div>
                <div class="mb-4">
                    <label for="reservation-name" class="block text-sm font-medium text-gray-700 mb-2">
                        ãŠåå‰ <span class="text-red-500">*</span>
                    </label>
                    <input 
                        id="reservation-name"
                        type="text" 
                        x-model="reservationName"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                        required
                    >
                </div>
                <div class="flex gap-3">
                    <button 
                        @click="createReservation"
                        :disabled="!reservationName.trim()"
                        class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        äºˆç´„ã™ã‚‹
                    </button>
                    <button 
                        @click="showReservationModal = false; reservationName = ''; selectedDateForReservation = null"
                        class="flex-1 bg-gray-200 text-gray-700 font-bold py-2 rounded-lg hover:bg-gray-300 transition">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
        </div>

        <!-- æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³ -->
        <div x-show="userId" class="mt-4">
            <button 
                @click="showReservationModal = true; selectedDateForReservation = null"
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                æ–°è¦äºˆç´„ã‚’ç™»éŒ²ã™ã‚‹
            </button>
        </div>
    </div>

    <script>
        const USER_ID_KEY = 'gym_reservation_user_id';
        const USER_NAME_KEY = 'gym_reservation_user_name';

        function getUserId() {
            return localStorage.getItem(USER_ID_KEY);
        }

        function getUserName() {
            return localStorage.getItem(USER_NAME_KEY);
        }

        function removeUserId() {
            localStorage.removeItem(USER_ID_KEY);
            localStorage.removeItem(USER_NAME_KEY);
        }

        function app() {
            return {
                userId: null,
                userName: '',
                currentYear: new Date().getFullYear(),
                currentMonth: new Date().getMonth(),
                reservations: [],
                showReservationModal: false,
                selectedDateForReservation: null,
                reservationName: '',
                
                get currentMonthReservations() {
                    const year = this.currentYear;
                    const month = this.currentMonth + 1;
                    const monthStr = month.toString().padStart(2, '0');
                    const prefix = `${year}-${monthStr}`;
                    
                    return this.reservations
                        .filter(r => r.date && r.date.startsWith(prefix))
                        .map(r => ({
                            ...r,
                            isMyReservation: r.user_name === this.userName
                        }))
                        .sort((a, b) => a.date.localeCompare(b.date));
                },
                
                async init() {
                    this.userId = getUserId();
                    this.userName = getUserName() || '';
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    if (!this.userId) {
                        window.location.href = '/login.html';
                        return;
                    }
                    
                    // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    await this.loadReservations();
                },
                
                async loadReservations() {
                    try {
                        const response = await fetch('/reservations');
                        if (response.ok) {
                            const data = await response.json();
                            this.reservations = data || [];
                        }
                    } catch (err) {
                        console.error('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                    }
                },
                
                getMonthYearLabel() {
                    const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                    return `${this.currentYear}å¹´ ${months[this.currentMonth]}`;
                },
                
                getCalendarDays() {
                    const year = this.currentYear;
                    const month = this.currentMonth;
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const firstDay = new Date(year, month, 1).getDay();
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    
                    const days = [];
                    
                    // ç©ºã®ã‚»ãƒ«ï¼ˆæœˆåˆã‚ã®ç©ºç™½ï¼‰
                    for (let i = 0; i < firstDay; i++) {
                        days.push({ date: '', isPast: false, isReserved: false, reservationCount: 0 });
                    }
                    
                    // æ—¥ä»˜ã‚»ãƒ«
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dateObj = new Date(year, month, day);
                        const isPast = dateStr < todayStr;
                        
                        // ã“ã®æ—¥ä»˜ã®äºˆç´„ã‚’å–å¾—
                        const dayReservations = this.reservations.filter(r => r.date === dateStr);
                        const myReservations = dayReservations.filter(r => r.user_name === this.userName);
                        const isMyReservation = myReservations.length > 0;
                        const reservationCount = dayReservations.length;
                        
                        days.push({
                            date: day,
                            dateStr: dateStr,
                            isPast: isPast,
                            isReserved: reservationCount > 0,
                            isMyReservation: isMyReservation,
                            reservationCount: reservationCount,
                            reservations: dayReservations
                        });
                    }
                    
                    return days;
                },
                
                getDateButtonClass(day) {
                    if (!day.date) return 'invisible'; // ç©ºç™½ã‚»ãƒ«
                    if (day.isPast) return 'bg-gray-100 text-gray-400 cursor-not-allowed';
                    if (day.isMyReservation) return 'bg-blue-200 border-blue-500 hover:bg-blue-300';
                    if (day.isReserved) return 'bg-gray-200 border-gray-400 hover:bg-gray-300';
                    return 'hover:bg-blue-50 border-gray-300';
                },
                
                getDateTooltip(day) {
                    if (!day.date || day.reservationCount === 0) return '';
                    const names = day.reservations.map(r => r.user_name).join(', ');
                    return `äºˆç´„è€…: ${names}`;
                },
                
                previousMonth() {
                    if (this.currentMonth === 0) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth--;
                    }
                },
                
                nextMonth() {
                    if (this.currentMonth === 11) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth++;
                    }
                },
                
                get selectedDateLabel() {
                    if (!this.selectedDateForReservation) return 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„';
                    const date = new Date(this.selectedDateForReservation);
                    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                },
                
                handleLogout() {
                    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        removeUserId();
                        window.location.href = '/login.html';
                    }
                },
                
                handleDateClick(day) {
                    if (!day.date || day.isPast) return;
                    
                    // è‡ªåˆ†ã®äºˆç´„ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆï¼ˆå°†æ¥çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ©Ÿèƒ½ç”¨ï¼‰
                    if (day.isMyReservation && day.reservationCount > 0) {
                        // ä»Šå›ã¯UIã®ã¿æº–å‚™ï¼ˆissue #5ã§å®Ÿè£…äºˆå®šï¼‰
                        return;
                    }
                    
                    // æ—¥ä»˜ã‚’é¸æŠã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    const dateStr = day.dateStr;
                    const [year, month, date] = dateStr.split('-');
                    this.selectedDateForReservation = new Date(parseInt(year), parseInt(month) - 1, parseInt(date));
                    this.reservationName = this.userName || '';
                    this.showReservationModal = true;
                },
                
                async createReservation() {
                    if (!this.reservationName.trim()) {
                        alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }
                    
                    if (!this.selectedDateForReservation) {
                        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                        return;
                    }
                    
                    const year = this.selectedDateForReservation.getFullYear();
                    const month = String(this.selectedDateForReservation.getMonth() + 1).padStart(2, '0');
                    const date = String(this.selectedDateForReservation.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${date}`;
                    
                    try {
                        const response = await fetch('/reservations', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_name: this.reservationName.trim(),
                                date: dateStr
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            alert(`äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼`);
                            this.showReservationModal = false;
                            this.reservationName = '';
                            this.selectedDateForReservation = null;
                            await this.loadReservations();
                        } else {
                            alert('äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.detail || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
                        }
                    } catch (err) {
                        alert('äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                        console.error(err);
                    }
                }
            };
        }
    </script>
</body>
</html>